box: wercker/default
build:
    steps:
        - shellcheck

        - script:
            name: config
            code: |
                GCLOUD_VERSION="127.0.0-linux-x86_64"
                GCLOUD_DIRNAME="google-cloud-sdk
                export KUBERNETES_VERSION="1.3.4"
                export KUBERNETES_SHA256="81f0e3c788241419be1ee961da8804fdb16657b86e7edba8c7070932e8a50fe7"
                export GCLOUD_SHA="45abe78986b0ff9a147904aaf20d552fa4ad6f29"
                export GCLOUD_FILENAME="${GCLOUD_DIRNAME}-${GCLOUD_VERSION}.tar.gz"
                export GCLOUD_URL="https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/${GCLOUD_FILENAME}"
                echo "Installing version $KUBERNETES_VERSION of kubernetes and ${GCLOUD_VERSION} of the Google Cloud SDK"

        - script:
            name: fetch kubernetes archive
            code: |
                curl -L https://storage.googleapis.com/kubernetes-release/release/v${KUBERNETES_VERSION}/bin/linux/amd64/kubectl > $WERCKER_OUTPUT_DIR/kubectl

        - script:
            name: validate kubernetes archive
            code: |
                cat $WERCKER_OUTPUT_DIR/kubectl| sha256sum | grep -q "$KUBERNETES_SHA256"

        - script:
            name: Fetch gcloud archive
            code: |
                curl -L ${GCLOUD_URL} -o ${GCLOUD_FILENAME}

        - script:
            name: Validate gcloud archive
            code: |
                shasum ${GCLOUD_FILENAME} | grep -q "${GCLOUD_SHA}"

        - script:
            name: Extract gcloud archive
            code: |
                tar -xzvf ${GCLOUD_FILENAME}

        - script:
            name: prepare output
            code: |
                cp "${WERCKER_ROOT}/{LICENSE,README.md,run.sh,wercker.yml,wercker-step.yml}" "${WERCKER_ROOT}/${GCLOUD_DIR}/bin/gcloud" "$WERCKER_OUTPUT_DIR"
                chmod ugo+rx "$WERCKER_OUTPUT_DIR/{gcloud,kubectl}"
